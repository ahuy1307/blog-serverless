name: Deploy Blog Serverless

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      stage:
        description: "Deployment stage (dev/prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    # Nếu bạn đang sử dụng Environment Secrets, hãy uncomment dòng dưới và thay tên environment của bạn
    environment: main # hoặc development, tùy thuộc vào cách bạn cấu hình secrets

    strategy:
      matrix:
        node-version: [20.x]
        python-version: [3.11]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Node.js dependencies
        run: |
          cd blog-cronjob
          npm install
          npm install serverless@3.35.2 -g

      #   - name: Install Python dependencies
      #     run: |
      #       cd blog-cronjob
      #       poetry install --no-interaction

      - name: Deploy with Serverless
        # Truyền các biến môi trường trực tiếp vào bước deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }} # Chỉ cần nếu bạn dùng Serverless Dashboard/Pro features
        run: |
          cd blog-cronjob
          echo "Serverless version:"
          serverless --version # Kiểm tra version
          # Sử dụng input stage nếu được kích hoạt thủ công, nếu không thì dùng 'dev'
          STAGE=${{ github.event.inputs.stage || 'dev' }}
          echo "Deploying to $STAGE environment"
          serverless deploy --stage $STAGE --verbose # Thêm --verbose để xem log chi tiết hơn
